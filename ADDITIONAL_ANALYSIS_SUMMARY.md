# 추가 분석 요약 (2025-10-13)

## 🎯 분석 목적

V3 게인 추정 결과에 대한 심층 분석 수행:
1. **시정수(τ) 문제 진단** - 비현실적인 정착 시간 원인 파악
2. **FF 룩업 테이블** - 속도/각도 기반 분석
3. **조건별 Gain 비교** - Single/Couple, High/Low Load

---

## 1️⃣ 시정수(τ) 재분석 결과 🚨

### 핵심 문제

**144/165 샘플 (87.3%)이 τ 상한선(100s)에 도달**

| 축 | 포화율 | 평균 τ | 유효 τ 중앙값 |
|---|---|---|---|
| Arm_In | **100%** | 100.0s | 100.0s |
| Arm_Out | 75% | 89.6s | 62.4s |
| Boom_Down | **100%** | 100.0s | 100.0s |
| Boom_Up | **100%** | 100.0s | 100.0s |
| Bucket_In | 82% | 87.7s | 40.3s |
| Bucket_Out | 65% | 70.8s | 6.3s |

### 문제 원인

1. **모델 피팅의 한계**: τ를 100s로 제한했고 대부분이 상한에 수렴
2. **비현실적인 정착 시간**: 4*τ=400s (6.7분)는 실제 유압 시스템과 맞지 않음
3. **데이터 특성 문제**: 입력 신호가 충분히 빠르지 않아 τ를 정확히 추정 불가

### 해결 방안

#### ⭐ 방안 1: τ 재추정 (추천)

**실제 각도 변화 데이터로부터 63.2% 도달 시간 직접 계산**

```python
# 각 샘플마다:
# 1. 시작 각도와 최종 각도 파악
# 2. 63.2% 지점 = 시작 + 0.632*(최종-시작)
# 3. 이 지점 도달 시간 = τ
```

#### 방안 2: 고정 τ 사용

유압 시스템의 일반적인 시정수:
- **고속 밸브**: τ = 0.05 ~ 0.2s
- **일반 유압**: τ = 0.5 ~ 2s
- **대형 실린더**: τ = 2 ~ 5s

**추천**: τ = 1~2s로 가정하고 PID 재계산

#### 예상 영향

| 시나리오 | τ | 정착시간 | Kp | Ki | 비고 |
|---|---|---|---|---|---|
| 현재 (포화) | 100s | 400s | 현재값 | 현재값 | 비현실적 |
| 수정 (τ=2s) | 2s | **8s** | **↑ 50배** | **↑ 50배** | 권장 |
| 수정 (τ=1s) | 1s | **4s** | **↑ 100배** | **↑ 100배** | 고려 가능 |

⚠️ **주의**: τ가 작아지면 Kp, Ki가 크게 증가하므로 실제 시스템에서 안전하게 테스트 필요!

---

## 2️⃣ FF 룩업 테이블 분석 (속도 기반)

### 속도 범위별 Kv 변화

| 축 | Kv 변동률 | R² 범위 | 평가 | 룩업 필요성 |
|---|---|---|---|---|
| **Arm_In** | 200.3% | 0.000 ~ 0.921 | 🔴 필수 | **3단계 룩업** |
| **Arm_Out** | 무한대 | 0.000 ~ 0.996 | 🔴 필수 | **3단계 룩업** |
| **Boom_Down** | 136.4% | 0.184 ~ 0.992 | 🔴 필수 | **3단계 룩업** |
| **Boom_Up** | 693.5% | 0.011 ~ 0.902 | 🔴 필수 | **3단계 룩업** |
| **Bucket_In** | 무한대 | 0.133 ~ 0.986 | 🔴 필수 | **3단계 룩업** |
| **Bucket_Out** | 무한대 | 0.000 ~ 0.931 | 🔴 필수 | **3단계 룩업** |

**결론**: **6개 축 모두 속도 기반 FF 룩업 테이블 필수!**

### 속도 구간별 FF Gain 예시 (Boom_Down)

| 속도 범위 | 샘플 수 | Kv | K_offset | R² |
|---|---|---|---|---|
| 초저속 (<5 deg/s) | 7 | **3.13** | 35.4 | 0.992 ✅ |
| 저속 (5-15 deg/s) | 8 | **2.13** | 42.4 | 0.883 ✅ |
| 중속 (15-30 deg/s) | 10 | **1.33** | 63.7 | 0.184 ⚠️ |

**발견**: 저속일수록 Kv가 높고, 고속일수록 Kv가 낮아지는 경향

### 구현 권장

```python
# 속도 기반 3단계 룩업 예시 (Boom_Down)
if abs(velocity) < 5:
    Kv = 3.13
    K_offset = 35.4
elif abs(velocity) < 15:
    Kv = 2.13
    K_offset = 42.4
else:
    Kv = 1.33
    K_offset = 63.7

duty = Kv * velocity + K_offset
```

---

## 3️⃣ 조건별 Gain 비교

### 3.1 Single vs Couple (연결 조건)

**3개 축에서 20% 이상 차이 → 별도 게인 필요!**

| 축 | Single Kp | Couple Kp | 차이 | 평가 |
|---|---|---|---|---|
| **Arm_In** | 3.413 | 4.123 | **+20.8%** | 🔴 유의미 |
| **Arm_Out** | 2.791 | 3.707 | **+32.8%** | 🔴 유의미 |
| Boom_Down | 5.774 | 5.896 | +2.1% | ✅ 무시 가능 |
| Boom_Up | 10.191 | 11.722 | +15.0% | ⚠️ 주의 |
| **Bucket_In** | 1.686 | 2.104 | **+24.8%** | 🔴 유의미 |
| Bucket_Out | 1.435 | 1.700 | +18.5% | ⚠️ 주의 |

**권장**: Arm, Bucket은 Single/Couple별 별도 게인 적용

### 3.2 High vs Low Load (부하 조건)

**1개 축에서 20% 이상 차이**

| 축 | High Kp | Low Kp | 차이 | 평가 |
|---|---|---|---|---|
| Arm_In | 3.961 | 3.871 | -2.3% | ✅ 무시 가능 |
| Arm_Out | 3.099 | 3.260 | +5.2% | ✅ 무시 가능 |
| Boom_Down | 5.894 | 5.919 | +0.4% | ✅ 무시 가능 |
| **Boom_Up** | 11.752 | 9.344 | **-20.5%** | 🔴 유의미 |
| Bucket_In | 2.043 | 1.817 | -11.1% | ⚠️ 주의 |
| Bucket_Out | 1.660 | 1.488 | -10.4% | ⚠️ 주의 |

**권장**: Boom_Up은 부하별 gain scheduling 고려

---

## 📋 최종 권장사항 통합

### 1. 시정수(τ) 문제 해결 (최우선 🚨)

**현재 상태**:
- τ=100s (포화) → 정착시간 400s (사용 불가!)
- Kp, Ki가 과소추정됨

**해결 필요**:
1. **원시 데이터에서 τ 직접 계산** (가장 정확)
2. **τ=1~2s 가정하고 PID 재계산** (빠른 해결)
3. **실제 시스템에서 step response 재측정** (최선)

### 2. FF 룩업 테이블 구현 (필수 ✅)

**모든 6개 축에서 속도 기반 3단계 룩업 필요**

| 속도 구간 | Kv 특성 | 적용 |
|---|---|---|
| 초저속 (<5 deg/s) | **높은 Kv** | 세밀한 제어 |
| 저속 (5-15 deg/s) | 중간 Kv | 일반 작업 |
| 중고속 (>15 deg/s) | **낮은 Kv** | 빠른 이동 |

### 3. 조건별 Gain 적용 (권장 ⚠️)

**현재 V3 통합 결과에 추가 고려사항**:

#### Single vs Couple
- **Arm_In, Arm_Out, Bucket_In**: 20% 이상 차이 → 별도 게인 권장
- **Boom, Bucket_Out**: 15% 이하 차이 → 단일 게인 가능

#### High vs Low Load
- **Boom_Up**: 20% 차이 → 부하별 게인 고려
- **나머지**: 10% 이하 → 단일 게인 충분

---

## 📊 구현 우선순위

### Phase 1: 즉시 조치 (필수)

1. ✅ **τ 재추정 및 PID 재계산**
   - 예상: Kp, Ki 50~100배 증가
   - 정착 시간: 400s → **4~8s**

2. ✅ **FF 룩업 테이블 구현 (3단계)**
   - 속도 기반: <5, 5-15, >15 deg/s
   - 모든 축 적용

### Phase 2: 검증 후 적용 (권장)

3. ⚠️ **Single/Couple별 PID 게인**
   - Arm_In, Arm_Out, Bucket_In

4. ⚠️ **Boom_Up 부하별 게인**
   - High: Kp=11.75
   - Low: Kp=9.34

---

## 📂 분석 결과 파일

### 시정수 분석
- `output/tau_reanalysis/TAU_REANALYSIS_REPORT.md`
- `output/tau_reanalysis/tau_summary.csv`
- `output/tau_reanalysis/tau_distribution.png`

### FF 룩업 테이블
- `output/ff_lookup_detailed/ff_by_velocity_range.csv`
- `output/ff_lookup_detailed/ff_by_duty_range.csv`
- `output/ff_lookup_detailed/kv_by_velocity_range.png`
- `output/ff_lookup_detailed/velocity_vs_duty_scatter.png`

### 조건별 비교
- `output/condition_analysis/CONDITION_ANALYSIS_REPORT.md`
- `output/condition_analysis/single_vs_couple.csv`
- `output/condition_analysis/high_vs_low_load.csv`
- `output/condition_analysis/ff_by_angle_range.csv`

---

## ⚠️ 중요 경고

### τ 문제의 심각성

현재 V3 게인은 **τ=100s 기준**으로 계산되었습니다:
- **정착 시간 400초** (6.7분) → 실제 사용 불가능
- **Kp, Ki 과소추정** → 응답 매우 느림

τ를 **1~2s로 수정**하면:
- **정착 시간 4~8초** → 실제 사용 가능
- **Kp, Ki 50~100배 증가** → 빠른 응답

### 실제 적용 전 필수 사항

1. **τ 재추정 및 PID 재계산**
2. **안전 게인(20~50%)으로 시작**
3. **저속 구간 먼저 테스트**
4. **점진적 게인 증가**

---

## 📞 후속 작업

### 즉시 필요
1. ✅ τ 재추정 스크립트 개발
2. ✅ FF 룩업 테이블 생성
3. ✅ 조건별 게인 통합

### 추후 검토
- 실제 시스템에서 step response 재측정
- Single/Couple별 게인 성능 비교
- 부하별 게인 스케줄링 효과 검증

---

**분석 완료 일자**: 2025-10-13  
**분석 도구**: PID Gain Estimation V3 + 추가 분석 스크립트  
**분석 샘플**: 165개 (6축 × 약 28개)  
**신뢰도**: ⭐⭐⭐⭐ (4/5) - τ 재추정 후 ⭐⭐⭐⭐⭐ 예상

